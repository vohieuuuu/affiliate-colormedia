ğŸ¯ Má»¤C TIÃŠU
NgÆ°á»i dÃ¹ng khi truy cáº­p / sáº½ Ä‘Æ°á»£c redirect Ä‘áº¿n:

/dashboard náº¿u role lÃ  normal

/kol-dashboard náº¿u role lÃ  KOL hoáº·c VIP

KhÃ´ng Ä‘Æ°á»£c redirect sá»›m khi dá»¯ liá»‡u user chÆ°a sáºµn sÃ ng

Äáº£m báº£o user.role luÃ´n cáº­p nháº­t Ä‘Ãºng, Ä‘áº·c biá»‡t sau khi táº¡o tÃ i khoáº£n hoáº·c cáº­p nháº­t

ğŸ› ï¸ Cáº¤U TRÃšC Tá»”NG QUAN
App.tsx: Ä‘á»‹nh nghÄ©a route / chuyá»ƒn vá» RoleRouter

RoleRouter.tsx: quyáº¿t Ä‘á»‹nh hÆ°á»›ng Ä‘i dá»±a vÃ o role

use-auth.ts: hook dÃ¹ng Ä‘á»ƒ láº¥y thÃ´ng tin ngÆ°á»i dÃ¹ng

ğŸ§± 1. KHáº®C PHá»¤C: RoleRouter.tsx (chi tiáº¿t tá»«ng dÃ²ng)
tsx
Copy
Edit
import { useEffect } from "react";
import { useLocation } from "wouter";
import { useAuth } from "@/hooks/use-auth";
import LoadingSpinner from "@/components/ui/loading-spinner"; // Hiá»ƒn thá»‹ loading trong lÃºc chá» user load

export default function RoleRouter() {
  const [, navigate] = useLocation();
  const { user, isLoading } = useAuth(); // Nháº­n user vÃ  loading state

  useEffect(() => {
    // âœ… Náº¿u dá»¯ liá»‡u user chÆ°a load xong, khÃ´ng redirect
    if (isLoading) return;

    // âŒ Náº¿u user null => chÆ°a Ä‘Äƒng nháº­p => chuyá»ƒn vá» login
    if (!user) {
      navigate("/auth", { replace: true });
    }

    // âœ… Náº¿u role lÃ  kol/vip, chuyá»ƒn vá» kol-dashboard
    else if (user.role === "kol" || user.role === "vip") {
      navigate("/kol-dashboard", { replace: true });
    }

    // âœ… Náº¿u lÃ  role bÃ¬nh thÆ°á»ng, chuyá»ƒn vá» dashboard
    else {
      navigate("/dashboard", { replace: true });
    }
  }, [user, isLoading, navigate]);

  return <LoadingSpinner />; // TrÃ¡nh hiá»ƒn thá»‹ tráº¯ng trang khi Ä‘ang load
}
ğŸ“¦ 2. KHáº®C PHá»¤C: use-auth.ts pháº£i Ä‘áº£m báº£o user luÃ´n Ä‘Æ°á»£c cáº­p nháº­t
Náº¿u báº¡n dÃ¹ng React Query:
ts
Copy
Edit
import { useQuery } from "@tanstack/react-query";
import axios from "axios";

export function useAuth() {
  const {
    data: user,
    isLoading,
    refetch,
  } = useQuery(["current-user"], async () => {
    const res = await axios.get("/api/me"); // API tráº£ thÃ´ng tin ngÆ°á»i dÃ¹ng
    return res.data;
  }, {
    staleTime: 0, // LuÃ´n luÃ´n fetch má»›i (hoáº·c báº¡n cÃ³ thá»ƒ Ä‘áº·t 1 phÃºt)
  });

  return { user, isLoading, refetch };
}
âœ… Quan trá»ng: Sau khi táº¡o user hoáº·c cáº­p nháº­t role => báº¡n pháº£i gá»i refetch() Ä‘á»ƒ Ä‘áº£m báº£o hook nháº­n Ä‘Æ°á»£c user má»›i vá»›i role má»›i.

ğŸ§ª 3. KHáº®C PHá»¤C: Sau khi Ä‘Äƒng kÃ½ hoáº·c táº¡o role KOL
VÃ­ dá»¥ báº¡n táº¡o má»™t user KOL/VIP xong:

tsx
Copy
Edit
const { refetch } = useAuth();

await axios.post("/api/create-user", { name, role: "kol" });
// Sau khi táº¡o, báº¡n cáº§n cáº­p nháº­t láº¡i user Ä‘ang Ä‘Äƒng nháº­p
await refetch(); // ğŸš¨ Quan trá»ng: cáº­p nháº­t láº¡i thÃ´ng tin user
navigate("/"); // â†’ Gá»i láº¡i RoleRouter â†’ tá»± redirect Ä‘Ãºng dashboard
ğŸ§¹ 4. Äáº¢M Báº¢O App.tsx ROUTING ÄÃšNG Æ¯U TIÃŠN
Cáº¥u trÃºc App.tsx báº¡n hiá»‡n cÃ³ lÃ  Ä‘Ãºng rá»“i:

tsx
Copy
Edit
<ProtectedRoute path="/" component={RoleRouter} />
<ProtectedRoute path="/kol-dashboard" component={KolDashboard} />
<ProtectedRoute path="/dashboard" component={Dashboard} />
Äáº·t / trÆ°á»›c cÃ¡c dashboard khÃ¡c Ä‘á»ƒ RoleRouter báº¯t Ä‘áº§u Ä‘iá»u hÆ°á»›ng

ProtectedRoute Ä‘áº£m báº£o chá»‰ user Ä‘Äƒng nháº­p má»›i vÃ o Ä‘Æ°á»£c

ğŸ“‹ Checklist debug:

âœ… Viá»‡c cáº§n kiá»ƒm tra	CÃ¡ch xá»­ lÃ½
User role cÃ³ Ä‘Ãºng khÃ´ng?	console.log(user.role) trong RoleRouter
Role bá»‹ cÅ© sau khi táº¡o user?	Gá»i refetch() sau khi táº¡o xong
Redirect sai lÃºc chÆ°a cÃ³ user?	Check isLoading === false má»›i xá»­ lÃ½
NgÆ°á»i dÃ¹ng váº«n vá» /dashboard?	Kiá»ƒm tra role cÃ³ pháº£i "kol" hay "vip" (so sÃ¡nh string Ä‘Ãºng)
Lá»—i quay láº¡i / rá»“i redirect láº¡i?	DÃ¹ng replace: true Ä‘á»ƒ trÃ¡nh láº·p